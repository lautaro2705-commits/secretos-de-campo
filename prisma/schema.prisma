generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================================
// 1. Categorías de Animal
// =====================================================================

model AnimalCategory {
  id          String   @id @default(uuid())
  name        String   @unique @db.VarChar(100)
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  yieldTemplates YieldTemplate[]
  stockBatches   StockBatch[]
  realYields     RealYield[]

  @@index([isActive])
  @@map("animal_categories")
}

// =====================================================================
// 2. Rangos de Peso
// =====================================================================

model WeightRange {
  id        String   @id @default(uuid())
  minWeight Decimal  @map("min_weight") @db.Decimal(8, 2)
  maxWeight Decimal  @map("max_weight") @db.Decimal(8, 2)
  label     String   @unique @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  yieldTemplates YieldTemplate[]
  stockBatches   StockBatch[]
  realYields     RealYield[]

  @@map("weight_ranges")
}

// =====================================================================
// 3. Cortes
// =====================================================================

model Cut {
  id           String  @id @default(uuid())
  name         String  @unique @db.VarChar(100)
  description  String?
  cutCategory  String? @map("cut_category") @db.VarChar(50)
  isSellable   Boolean @default(true) @map("is_sellable")
  displayOrder Int     @default(0) @map("display_order")
  isActive     Boolean @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  yieldTemplateItems   YieldTemplateItem[]
  stockBatchProjections StockBatchProjection[]
  realYieldItems       RealYieldItem[]
  inventory            Inventory?
  inventoryAdjustments InventoryAdjustment[]
  prices               Price[]
  saleItems            SaleItem[]

  @@index([isSellable])
  @@index([isActive])
  @@map("cuts")
}

// =====================================================================
// 4. Plantillas de Rendimiento
// =====================================================================

model YieldTemplate {
  id              String   @id @default(uuid())
  categoryId      String   @map("category_id")
  rangeId         String   @map("range_id")
  name            String?  @db.VarChar(200)
  referenceWeight Decimal? @map("reference_weight") @db.Decimal(8, 2)
  notes           String?
  status          String   @default("active") @db.VarChar(20)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  category AnimalCategory @relation(fields: [categoryId], references: [id])
  range    WeightRange    @relation(fields: [rangeId], references: [id])
  items    YieldTemplateItem[]
  batches  StockBatch[]

  @@unique([categoryId, rangeId])
  @@index([status])
  @@map("yield_templates")
}

// =====================================================================
// 5. Items de Plantilla (La Fórmula)
// =====================================================================

model YieldTemplateItem {
  id              String  @id @default(uuid())
  templateId      String  @map("template_id")
  cutId           String  @map("cut_id")
  percentageYield Decimal @map("percentage_yield") @db.Decimal(5, 2)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  template YieldTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  cut      Cut           @relation(fields: [cutId], references: [id])

  @@unique([templateId, cutId])
  @@index([templateId])
  @@map("yield_template_items")
}

// =====================================================================
// 6. Proveedores
// =====================================================================

model Supplier {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(200)
  razonSocial String?  @map("razon_social") @db.VarChar(200)
  cuit        String?  @unique @db.VarChar(13)
  phone       String?  @db.VarChar(50)
  email       String?  @db.VarChar(200)
  address     String?
  notes       String?
  balance     Decimal  @default(0) @db.Decimal(12, 2)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  stockBatches     StockBatch[]
  supplierInvoices SupplierInvoice[]

  @@index([isActive])
  @@map("suppliers")
}

// =====================================================================
// 7. Clientes
// =====================================================================

model Customer {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(200)
  phone       String?  @db.VarChar(50)
  email       String?  @db.VarChar(200)
  address     String?
  dni         String?  @db.VarChar(20)
  notes       String?
  creditLimit Decimal  @default(0) @map("credit_limit") @db.Decimal(12, 2)
  balance     Decimal  @default(0) @db.Decimal(12, 2)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  sales Sale[]

  @@index([isActive])
  @@map("customers")
}

// =====================================================================
// 8. Lotes de Stock
// =====================================================================

model StockBatch {
  id         String   @id @default(uuid())
  entryDate  DateTime @default(now()) @map("entry_date") @db.Date
  supplierId String?  @map("supplier_id")
  categoryId String   @map("category_id")
  rangeId    String   @map("range_id")
  templateId String?  @map("template_id")
  unitCount  Int      @map("unit_count")
  totalWeight Decimal @map("total_weight") @db.Decimal(10, 2)
  totalCost  Decimal  @map("total_cost") @db.Decimal(12, 2)
  notes      String?
  status     String   @default("projected") @db.VarChar(20)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz

  supplier    Supplier?       @relation(fields: [supplierId], references: [id])
  category    AnimalCategory  @relation(fields: [categoryId], references: [id])
  range       WeightRange     @relation(fields: [rangeId], references: [id])
  template    YieldTemplate?  @relation(fields: [templateId], references: [id])
  projections StockBatchProjection[]
  invoice     SupplierInvoice?

  @@index([entryDate(sort: Desc)])
  @@index([supplierId])
  @@map("stock_batches")
}

// =====================================================================
// 9. Proyecciones de Lote
// =====================================================================

model StockBatchProjection {
  id             String  @id @default(uuid())
  batchId        String  @map("batch_id")
  cutId          String  @map("cut_id")
  estimatedKg    Decimal @map("estimated_kg") @db.Decimal(10, 2)
  percentageUsed Decimal @map("percentage_used") @db.Decimal(5, 2)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz

  batch StockBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  cut   Cut        @relation(fields: [cutId], references: [id])

  @@unique([batchId, cutId])
  @@index([batchId])
  @@map("stock_batch_projections")
}

// =====================================================================
// 10. Inventario
// =====================================================================

model Inventory {
  id            String  @id @default(uuid())
  cutId         String  @unique @map("cut_id")
  currentQty    Decimal @default(0) @map("current_qty") @db.Decimal(10, 2)
  minStockAlert Decimal @default(0) @map("min_stock_alert") @db.Decimal(10, 2)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  cut Cut @relation(fields: [cutId], references: [id])

  @@map("inventory")
}

// =====================================================================
// 11. Ajustes de Inventario
// =====================================================================

model InventoryAdjustment {
  id          String   @id @default(uuid())
  cutId       String   @map("cut_id")
  previousQty Decimal  @map("previous_qty") @db.Decimal(10, 2)
  newQty      Decimal  @map("new_qty") @db.Decimal(10, 2)
  reason      String   @db.VarChar(50)
  notes       String?
  adjustedBy  String?  @map("adjusted_by") @db.VarChar(200)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  cut Cut @relation(fields: [cutId], references: [id])

  @@index([cutId])
  @@index([createdAt(sort: Desc)])
  @@map("inventory_adjustments")
}

// =====================================================================
// 12. Listas de Precios
// =====================================================================

model PriceList {
  id          String    @id @default(uuid())
  name        String    @db.VarChar(200)
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  validFrom   DateTime? @map("valid_from") @db.Date
  validUntil  DateTime? @map("valid_until") @db.Date
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  prices Price[]

  @@map("price_lists")
}

// =====================================================================
// 13. Precios
// =====================================================================

model Price {
  id             String  @id @default(uuid())
  priceListId    String  @map("price_list_id")
  cutId          String  @map("cut_id")
  costPerKg      Decimal @default(0) @map("cost_per_kg") @db.Decimal(12, 2)
  sellPricePerKg Decimal @map("sell_price_per_kg") @db.Decimal(12, 2)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz

  priceList PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  cut       Cut       @relation(fields: [cutId], references: [id])

  @@unique([priceListId, cutId])
  @@index([priceListId])
  @@index([cutId])
  @@map("prices")
}

// =====================================================================
// 14. Métodos de Pago
// =====================================================================

model PaymentMethod {
  id                   String  @id @default(uuid())
  name                 String  @unique @db.VarChar(100)
  surchargePercentage  Decimal @default(0) @map("surcharge_percentage") @db.Decimal(5, 2)
  isActive             Boolean @default(true) @map("is_active")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamptz

  salePayments     SalePayment[]
  supplierPayments SupplierPayment[]

  @@map("payment_methods")
}

// =====================================================================
// 15. Ventas
// =====================================================================

model Sale {
  id              String   @id @default(uuid())
  saleNumber      Int      @default(autoincrement()) @map("sale_number")
  customerId      String?  @map("customer_id")
  saleDate        DateTime @default(now()) @map("sale_date") @db.Timestamptz
  subtotal        Decimal  @default(0) @db.Decimal(12, 2)
  discountAmount  Decimal  @default(0) @map("discount_amount") @db.Decimal(12, 2)
  surchargeAmount Decimal  @default(0) @map("surcharge_amount") @db.Decimal(12, 2)
  total           Decimal  @default(0) @db.Decimal(12, 2)
  status          String   @default("completed") @db.VarChar(20)
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  customer Customer?     @relation(fields: [customerId], references: [id])
  items    SaleItem[]
  payments SalePayment[]

  @@index([saleDate(sort: Desc)])
  @@index([customerId])
  @@index([status])
  @@map("sales")
}

// =====================================================================
// 16. Items de Venta
// =====================================================================

model SaleItem {
  id         String  @id @default(uuid())
  saleId     String  @map("sale_id")
  cutId      String  @map("cut_id")
  quantityKg Decimal @map("quantity_kg") @db.Decimal(10, 2)
  pricePerKg Decimal @map("price_per_kg") @db.Decimal(12, 2)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)
  cut  Cut  @relation(fields: [cutId], references: [id])

  @@index([saleId])
  @@index([cutId])
  @@map("sale_items")
}

// =====================================================================
// 17. Pagos de Venta
// =====================================================================

model SalePayment {
  id              String  @id @default(uuid())
  saleId          String  @map("sale_id")
  paymentMethodId String  @map("payment_method_id")
  amount          Decimal @db.Decimal(12, 2)
  reference       String? @db.VarChar(200)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  sale          Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  paymentMethod PaymentMethod @relation(fields: [paymentMethodId], references: [id])

  @@index([saleId])
  @@map("sale_payments")
}

// =====================================================================
// 18. Facturas de Proveedores
// =====================================================================

model SupplierInvoice {
  id            String   @id @default(uuid())
  supplierId    String   @map("supplier_id")
  invoiceNumber String?  @map("invoice_number") @db.VarChar(100)
  invoiceDate   DateTime @default(now()) @map("invoice_date") @db.Date
  dueDate       DateTime? @map("due_date") @db.Date
  totalAmount   Decimal  @map("total_amount") @db.Decimal(12, 2)
  paidAmount    Decimal  @default(0) @map("paid_amount") @db.Decimal(12, 2)
  status        String   @default("pending") @db.VarChar(20)
  notes         String?
  batchId       String?  @unique @map("batch_id")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  supplier Supplier          @relation(fields: [supplierId], references: [id])
  batch    StockBatch?       @relation(fields: [batchId], references: [id])
  payments SupplierPayment[]

  @@index([supplierId])
  @@index([status])
  @@map("supplier_invoices")
}

// =====================================================================
// 19. Pagos a Proveedores
// =====================================================================

model SupplierPayment {
  id              String   @id @default(uuid())
  invoiceId       String   @map("invoice_id")
  paymentMethodId String   @map("payment_method_id")
  amount          Decimal  @db.Decimal(12, 2)
  paymentDate     DateTime @default(now()) @map("payment_date") @db.Date
  reference       String?  @db.VarChar(200)
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  invoice       SupplierInvoice @relation(fields: [invoiceId], references: [id])
  paymentMethod PaymentMethod   @relation(fields: [paymentMethodId], references: [id])

  @@index([invoiceId])
  @@map("supplier_payments")
}

// =====================================================================
// 20. Desposte Real (registro manual de rendimiento real)
// =====================================================================

model RealYield {
  id            String   @id @default(uuid())
  categoryId    String   @map("category_id")
  rangeId       String   @map("range_id")
  totalWeight   Decimal  @map("total_weight") @db.Decimal(10, 2)
  yieldNumber   Int      @default(autoincrement()) @map("yield_number")
  notes         String?
  appliedToTemplate Boolean @default(false) @map("applied_to_template")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  category AnimalCategory @relation(fields: [categoryId], references: [id])
  range    WeightRange    @relation(fields: [rangeId], references: [id])
  items    RealYieldItem[]

  @@index([categoryId, rangeId])
  @@index([createdAt(sort: Desc)])
  @@map("real_yields")
}

// =====================================================================
// 21. Items de Desposte Real (kg reales por corte)
// =====================================================================

model RealYieldItem {
  id            String  @id @default(uuid())
  realYieldId   String  @map("real_yield_id")
  cutId         String  @map("cut_id")
  actualKg      Decimal @map("actual_kg") @db.Decimal(10, 2)
  percentageReal Decimal @map("percentage_real") @db.Decimal(5, 2)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  realYield RealYield @relation(fields: [realYieldId], references: [id], onDelete: Cascade)
  cut       Cut       @relation(fields: [cutId], references: [id])

  @@unique([realYieldId, cutId])
  @@index([realYieldId])
  @@map("real_yield_items")
}
